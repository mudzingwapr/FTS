--------------------------------------------------------
--  File created - Tuesday-December-15-2020   
--------------------------------------------------------
--------------------------------------------------------
--  DDL for Procedure POST_INCREASE_REP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "PENSION"."POST_INCREASE_REP" (REP_ID NUMBER,PENSION_TYPE IN VARCHAR2) AS 
	F_OUT UTL_FILE.FILE_TYPE;
	F_OUT2 UTL_FILE.FILE_TYPE;
	C_OUT UTL_FILE.FILE_TYPE;
	V_DEST VARCHAR2(100):='REPORTS';
	V_TEXT VARCHAR2(500);
	V_REPORT VARCHAR2(50);
	V_SECTION VARCHAR2(50);
 MINPEN NUMBER(26,2);
 payperiod NUMBER(6);
 REPID NUMBER(6);
 PENS_TYPE VARCHAR2(2);

	PROCEDURE CTL_FILE IS 
	BEGIN
  F_OUT:=UTL_FILE.FOPEN(V_DEST,V_REPORT||TO_CHAR(SYSDATE,'-MON-YY')||'.CSV','W');	
		UTL_FILE.PUT_LINE(C_OUT,V_REPORT||TO_CHAR(SYSDATE,'-MON-YY')||'.CSV');

	END;

	PROCEDURE POLYGAMOUS_SPOUSES IS 
	BEGIN	
		CTL_FILE;
		UTL_FILE.PUT_LINE(F_OUT,'DECEASED ID,DECEASED SURNAME,DECEASED FIRST NAMES,DECEASED DATE LEFT,ORG,GRADE,SPOUSE ID,SPOUSE SURNAME,SPOUSE FIRST NAMES,NEW AMOUNT,OLD AMOUNT');
		
		FOR REC IN (
				SELECT "DECEASED ID"||','||D.PER_SURNAME||','||D.PER_FNAME
				||','||TO_CHAR(D.PER_LEFT,'DD-MON-YYYY')||','||D.PER_ORG_CODE||','||D.PER_GRD_CODE||','||"SPOUSE ID"||','||"SPOUSE SURNAME"||','||"SPOUSE FIRST NAMES"||','||"NEW AMOUNT"||','||"OLD AMOUNT" TEXT FROM (
				SELECT W.DEP_PERID "SPOUSE ID",S.PER_SURNAME "SPOUSE SURNAME",PER_FNAME "SPOUSE FIRST NAMES",SPD_AMT "NEW AMOUNT", 
				(SELECT MAX(O.SPD_AMT) FROM PAY_SPAY_DED O WHERE O.SPD_PER_ID=W.DEP_PERID AND O.SPD_PDC_CODE=N.SPD_PDC_CODE AND O.SPD_TDATE IS NOT NULL
				AND O.SPD_CLM_SERIAL=N.SPD_CLM_SERIAL-1) "OLD AMOUNT", W.DEP_PER_ID "DECEASED ID" FROM PER_DEPENDENT W, PER_PERSON S, PAY_SPAY_DED N WHERE 
				S.PER_ID=W.DEP_PERID
				AND W.DEP_PERID=SPD_PER_ID
				and N.SPD_PDC_CODE in (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='S') 
				and S.per_dod is null
				and nvl(S.per_suspended,'N')!='Y'
				and S.PER_PAYSTOP is null
				and N.spd_tdate IS NULL
				and N.spd_audit='Y'
				and N.spd_updt='Y'
				AND IS_POLYGAMOUS(W.DEP_PERID)='Y'
				AND DEP_RELATION='W') Q, PER_PERSON D
				WHERE Q."DECEASED ID"=D.PER_ID
				ORDER BY  TEXT)
										
		LOOP
			UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);				
		END LOOP;
		UTL_FILE.FCLOSE(F_OUT);
	END; 

 PROCEDURE POLYGAMOUS_SHARING_MINIMUM IS 
 BEGIN
  SELECT get_min_pension(SYSDATE) INTO minpen FROM DUAL;		
		CTL_FILE;
		UTL_FILE.PUT_LINE(F_OUT,'DECEASED ID,DECEASED SURNAME,DECEASED FIRST NAME,DECEASED DOB,DECEASED DOD,DECEASED SEX,SPOUSE ID,AMOUNT,CODE,CLAIM NO,SPOUSE SURNAME,SPOUSE FIRST NAMES,SPOUSE DOB,SPOUSE SEX');
		
		FOR REC IN (
				SELECT "DECEASED_ID"||','||D.PER_SURNAME||','||D.PER_FNAME
				||','||TO_CHAR(D.PER_DOB,'DD-MON-YYYY')||','||TO_CHAR(D.PER_DOD,'DD-MON-YYYY')||','||D.PER_SEX||','||"SPOUSE_ID"||','||"AMOUNT"||','||TO_CHAR(CODE)||','||"CLAIM_NO"||','||"SPOUSE_SURNAME"||','||"SPOUSE_FORENAME"||','||TO_CHAR(SPOUSE_DOB,'DD-MON-YYYY')||','||SPOUSE_GENDER TEXT FROM (
    select SPD_PER_ID SPOUSE_ID,SPD_AMT AMOUNT,SPD_PDC_CODE CODE,SPD_CLM_NO CLAIM_NO,PER_FNAME SPOUSE_FORENAME,PER_SURNAME SPOUSE_SURNAME,PER_DOB SPOUSE_DOB,PER_SEX SPOUSE_GENDER, 
    (SELECT CLM_PID FROM CLM_CLAIM WHERE CLM_NO=SPD_CLM_NO) DECEASED_ID from pay_spay_ded, PER_PERSON  where
    PER_ID=SPD_PER_ID
    AND IS_POLYGAMOUS(SPD_PER_ID)='Y'
    and spd_tdate is null
    and spd_pdc_code in (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='S') 
    ) W, PER_PERSON D
    WHERE D.PER_ID=DECEASED_ID
    and amount in (minpen,round( minpen /2,2), round( minpen /3,2),round( minpen /4,2),round( minpen /5,2),round( minpen /6,2))
				ORDER BY  TEXT)
										
		LOOP
			UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);				
		END LOOP;
		UTL_FILE.FCLOSE(F_OUT);
 END;

 PROCEDURE SPOUSE_RECEIVING_MORE_ONE_PENS IS
 BEGIN	
		CTL_FILE;
		UTL_FILE.PUT_LINE(F_OUT,'SURNAME,FIRST NAMES,NID,PID,ORG,GRADE,REASON,BENID,CODE,FROM DATE,AMT,PF NUMBER');
		
		FOR REC IN (
				SELECT "SURNAME"||','||"FIRST NAMES"||',="'||NID||'",'||"PID"||','||"ORG"||','||"GRADE"||','||REASON||','||BENID||','||CODE||','||TO_CHAR("FROM DATE",'DD-MON-YYYY')||','||AMT||','||"PF NUMBER" TEXT FROM (
SELECT DISTINCT B.PER_SURNAME "SURNAME", B.PER_FNAME "FIRST NAMES", B.PER_NID "NID", A.SPD_PER_ID "PID", B.PER_ORG_CODE "ORG",B.PER_GRD_CODE "GRADE", 
B.PER_LSC_CODE "REASON", C.SPD_BENID "BENID", C.SPD_PDC_CODE "CODE",C.SPD_FDATE "FROM DATE",C.SPD_AMT "AMT",
listagg(pf_type||'-'||pf_body,',') within group (order by pf_type||pf_body) as "PF NUMBER" 
FROM (
SELECT DISTINCT N.SPD_PER_ID, COUNT(N.SPD_PDC_CODE) FROM PAY_SPAY_DED N
WHERE N.SPD_PER_ID IN (
SELECT DISTINCT DEP_PERID FROM PER_DEPENDENT
WHERE DEP_RELATION='W')
and N.SPD_PDC_CODE in (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY IN ('O','S')) 
and N.spd_tdate IS NULL
and N.spd_audit='Y'
and N.spd_updt='Y'
GROUP BY SPD_PER_ID
HAVING COUNT(SPD_PDC_CODE)>1) A, PER_PERSON B, PAY_SPAY_DED C, FTS_MASTER
WHERE A.SPD_PER_ID=B.PER_ID
AND A.SPD_PER_ID=C.SPD_PER_ID
AND A.SPD_PER_ID=FTS_MASTER.PER_ID(+)
and B.per_dod is null
and nvl(B.per_suspended,'N') != 'Y'
and B.PER_PAYSTOP is null
and C.SPD_PDC_CODE in (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY IN ('O','S')) 
and C.spd_tdate IS NULL
and C.spd_audit='Y'
and C.spd_updt='Y'
GROUP BY B.PER_SURNAME , B.PER_FNAME , B.PER_NID, A.SPD_PER_ID, B.PER_ORG_CODE,B.PER_GRD_CODE , 
B.PER_LSC_CODE, C.SPD_BENID, C.SPD_PDC_CODE,C.SPD_FDATE,C.SPD_AMT)
				ORDER BY  TEXT)
										
		LOOP
			UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);				
		END LOOP;
		UTL_FILE.FCLOSE(F_OUT); 
 END;
	
 PROCEDURE SPOUSE_RECEIVE_MORE_SPOUSE_PEN IS
 BEGIN
		CTL_FILE;
		UTL_FILE.PUT_LINE(F_OUT,'DECEASED PID,DECEASED SURNAME,DECEASED FIRST NAMES,DECEASED DATE LEFT,ORG,GRADE,REASON,DECEASED INDEX,SPOUSE SURNAME,SPOUSE FIRST NAMES,PAYING CODE,AMT,PF NUMBER');
		FOR REC IN (
SELECT "DECEASED PID"||','||"DECEASED SURNAME"||','||"DECEASED FIRST NAMES"||','||"DECEASED LEFT"||','||"ORG"||','||"GRADE"||','||REASON||','||"DECEASED INDEX"||','||"SPOUSE PID"||','||"SPOUSE SURNAME"||','||"SPOUSE FIRST NAMES"||','||"PAYING CODE"||','||"AMT"||','||"PF NUMBER" TEXT FROM (
SELECT Q."DECEASED PID", TO_CHAR(D.PER_LEFT,'DD-MON-YYYY') "DECEASED LEFT", D.PER_SURNAME "DECEASED SURNAME",D.PER_FNAME "DECEASED FIRST NAMES", D.PER_GRD_CODE "GRADE", D.PER_ORG_CODE "ORG",D.PER_LSC_CODE "REASON", 
ROUND(D.PER_INCPERC,2) "DECEASED INDEX",Q."SPOUSE PID",Q."SPOUSE SURNAME",Q."SPOUSE FIRST NAMES",Q."PAYING CODE",Q."AMT","PF NUMBER"  FROM (
SELECT W.DEP_PERID "SPOUSE PID",S.PER_SURNAME "SPOUSE SURNAME",PER_FNAME "SPOUSE FIRST NAMES",SPD_AMT "AMT", 
 W.DEP_PER_ID "DECEASED PID",N.SPD_PDC_CODE "PAYING CODE",
 listagg(pf_type||'-'||pf_body,',') within group (order by pf_type||pf_body) "PF NUMBER" 
 FROM PER_DEPENDENT W, PER_PERSON S, PAY_SPAY_DED N, FTS_MASTER 
 WHERE S.PER_ID=W.DEP_PERID
AND W.DEP_PERID=SPD_PER_ID
AND SPD_PER_ID=FTS_MASTER.PER_ID(+)
and N.SPD_PDC_CODE IN (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='S') 
and S.per_dod is null
and nvl(S.per_suspended,'N') !='Y'
and S.PER_PAYSTOP is null
and N.spd_tdate IS NULL
and N.spd_audit='Y'
and N.spd_updt='Y'
AND W.DEP_PERID IN (
SELECT DISTINCT SPD_PER_ID FROM (
SELECT SPD_PER_ID ,COUNT(SPD_PDC_CODE) FROM PAY_SPAY_DED
WHERE SPD_PDC_CODE in (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='S') 
and spd_tdate IS NULL
and spd_audit='Y'
and spd_updt='Y'    
GROUP BY SPD_PER_ID
HAVING COUNT(SPD_PDC_CODE) > 1)
)
AND DEP_RELATION='W'
GROUP BY W.DEP_PERID,S.PER_SURNAME,PER_FNAME,SPD_AMT, 
 W.DEP_PER_ID,N.SPD_PDC_CODE
 ) Q, PER_PERSON D
WHERE Q."DECEASED PID"=D.PER_ID)
ORDER BY  TEXT)								
		LOOP
			UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);				
		END LOOP;
  UTL_FILE.FCLOSE(F_OUT); 
 END;

 PROCEDURE SPOUSE_NT_SHARNG_RECE_LESS_MIN IS 
 BEGIN
  SELECT get_min_pension(SYSDATE) INTO minpen FROM DUAL;	
		CTL_FILE;
		UTL_FILE.PUT_LINE(F_OUT,'DECEASED SURNAME,DECEASED FIRST NAMES,DECEASED PID,DECEASED DOB,DECEASED DOD,DECEASED SEX,SPOUSE SURNAME,SPOUSE FIRST NAMES,SPOUSE PID,SPOUSE DOB,SPOUSE SEX,CODE,CLAIM NO,AMT');

  FOR REC IN (
  SELECT DECEASED_SURNAME||','||DECEASED_FORENAME||','||DECEASED_ID||','||TO_CHAR(DECEASED_DOB,'DD-MON-YYYY')||','||TO_CHAR(DECEASED_DOD,'DD-MON-YYYY')||','||DECEASED_GENDER||','||
  SPOUSE_SURNAME||','||SPOUSE_FORENAME||','||SPOUSE_ID||','||TO_CHAR(SPOUSE_DOB,'DD-MON-YYYY')||','||SPOUSE_GENDER||','||CODE||','||CLAIM_NO||','||AMOUNT TEXT FROM (
  SELECT W.*, D.PER_FNAME DECEASED_FORENAME,TRIM(D.PER_SURNAME) DECEASED_SURNAME,D.PER_DOB DECEASED_DOB,D.PER_DOD DECEASED_DOD,D.PER_SEX DECEASED_GENDER FROM (
select SPD_PER_ID SPOUSE_ID,SPD_AMT AMOUNT,SPD_PDC_CODE CODE,SPD_CLM_NO CLAIM_NO,PER_FNAME SPOUSE_FORENAME,PER_SURNAME SPOUSE_SURNAME,PER_DOB SPOUSE_DOB,PER_SEX SPOUSE_GENDER, 
(SELECT CLM_PID FROM CLM_CLAIM WHERE CLM_NO=SPD_CLM_NO) DECEASED_ID from pay_spay_ded, PER_PERSON  where
PER_ID=SPD_PER_ID
and spd_audit='Y'
and spd_updt='Y' 
AND spd_clm_no in (
select spd_clm_no from (
select count(spd_per_id),spd_clm_no from pay_spay_ded where spd_tdate is null 
and spd_pdc_code IN (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='S') group by spd_clm_no
having count(spd_per_id)=1))
and spd_tdate is null
and spd_audit='Y'
and spd_updt='Y' 
and spd_pdc_code IN (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='S')
) W, PER_PERSON D
WHERE D.PER_ID=DECEASED_ID and amount < minpen) ORDER BY TEXT)

  LOOP
   UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);		
  END LOOP;
  UTL_FILE.FCLOSE(F_OUT);
 END;

 PROCEDURE SPOUSES_ON_MINIMUN IS 
 BEGIN  
  SELECT get_min_pension(SYSDATE) INTO minpen FROM DUAL;
		CTL_FILE;
		UTL_FILE.PUT_LINE(F_OUT,'SPOUSE ID,AMT,CODE,CLAIM NO,SPOUSE SURNAME,SPOUSE FIRST NAMES,SPOUSE DOB,SPOUSE SEX,DECEASED ID,DECEASED SURNAME,DECEASED FIRST NAMES,DECEASED DOB,DECEASED DOD,DECEASED SEX');

  FOR REC IN (
   SELECT SPOUSE_ID||','||AMOUNT||','||CODE||','||CLAIM_NO||','||SPOUSE_SURNAME||','||SPOUSE_FORENAME||','||TO_CHAR(SPOUSE_DOB,'DD-MON-YYYY')||','||SPOUSE_GENDER||','||DECEASED_ID||','||DECEASED_SURNAME||','||
   DECEASED_FORENAME||','||TO_CHAR(DECEASED_DOB,'DD-MON-YYYY')||','||TO_CHAR(DECEASED_DOD,'DD-MON-YYYY')||','||DECEASED_GENDER TEXT FROM (
    SELECT W.*, D.PER_FNAME DECEASED_FORENAME,D.PER_SURNAME DECEASED_SURNAME,D.PER_DOB DECEASED_DOB,D.PER_DOD DECEASED_DOD,D.PER_SEX DECEASED_GENDER FROM (
     select SPD_PER_ID SPOUSE_ID,SPD_AMT AMOUNT,SPD_PDC_CODE CODE,SPD_CLM_NO CLAIM_NO,PER_FNAME SPOUSE_FORENAME,PER_SURNAME SPOUSE_SURNAME,PER_DOB SPOUSE_DOB,PER_SEX SPOUSE_GENDER, 
     (SELECT CLM_PID FROM CLM_CLAIM WHERE CLM_NO=SPD_CLM_NO) DECEASED_ID from pay_spay_ded, PER_PERSON  
     where PER_ID=SPD_PER_ID
     and spd_tdate is null
     and spd_pdc_code IN (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='S')
    ) W, PER_PERSON D
   WHERE D.PER_ID=DECEASED_ID
   AND amount = minpen 
   ORDER BY CLAIM_NO,SPOUSE_ID))
  LOOP
   UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);		
  END LOOP;
  UTL_FILE.FCLOSE(F_OUT);
 END;

 PROCEDURE DUPLICAT_ARRS_ON_ADHOC_N_STATI IS 
 BEGIN
  SELECT COM_PAYPERIOD INTO payperiod FROM GLB_COMPANY_PROFILE;	
		CTL_FILE;
		UTL_FILE.PUT_LINE(F_OUT,'TYPE,PID,SURNAME,FIRST NAMES,CODE,CLAIM NO,BENID,AMT');

  FOR REC IN (
   SELECT 'STATIC'||','||PID||','||PER_SURNAME||','||PER_FNAME||','||CODE||','||CLAIM_CODE||','||CLAIM_NO||','||BENID||','||AMT TEXT FROM (
   SELECT DISTINCT spd_per_id "PID",PER_SURNAME,PER_FNAME,SPD_PDC_CODE "CODE",SPD_CLC_CODE "CLAIM_CODE", SPD_CLM_NO "CLAIM_NO", spd_benid "BENID", SPD_AMT "AMT" FROM (
    select count(*),SPD_PDC_CODE,spd_per_id,SPD_CLC_CODE,spd_benid, SPD_CLM_NO,sPD_AMT from pay_spay_ded,REF_PDCODE 
    where spd_tdate IS NULL
    AND	SPD_PDC_CODE = PDC_CODE
    AND SPD_PDC_PDT_CODE = PDC_PDT_CODE
    AND PDC_PDFLAG='P'
    and spd_audit='Y'
    and spd_updt='Y' 
    group by spd_per_id,SPD_PDC_CODE,SPD_CLC_CODE,spd_benid,SPD_CLM_NO,SPD_AMT
    having count(*) >1) A, PER_PERSON P
   WHERE A.spd_per_id=P.PER_ID
   and p.per_dod is null
   and nvl(p.per_suspended,'N') !='Y'
   and p.PER_PAYSTOP is null))
  LOOP
   UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);		
  END LOOP;

  FOR REC IN (
   SELECT 'ADHOC'||','||PID||','||PER_SURNAME||','||PER_FNAME||','||CODE||','||CLAIM_CODE||','||CLAIM_NO||','||BENID||','||AMT TEXT FROM (
    SELECT DISTINCT mpd_per_id "PID",PER_SURNAME,PER_FNAME,MPD_PDC_CODE "CODE",MPD_CLC_CODE "CLAIM_CODE", mpd_clm_no CLAIM_NO, mpd_benid "BENID", MPD_AMT "AMT" FROM (
    select count(*),MPD_PDC_CODE,mpd_per_id,MPD_CLC_CODE, MPD_AMT, mpd_benid,mpd_clm_no from pay_mpay_ded,REF_PDCODE 
    where mpd_period = payperiod
    AND	MPD_PDC_CODE = PDC_CODE
    AND MPD_PDC_PDT_CODE = PDC_PDT_CODE
    AND PDC_PDFLAG='P'
    and mpd_audit='Y'
    and mpd_updt='Y' 
    group by mpd_per_id,MPD_PDC_CODE,MPD_CLC_CODE,MPD_AMT,mpd_benid,mpd_clm_no
    having count(*) >1) A, PER_PERSON P
   WHERE A.mpd_per_id=P.PER_ID
   and p.per_dod is null
   and nvl(p.per_suspended,'N') !='Y'
   and p.PER_PAYSTOP is null))
  LOOP
   UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);		
  END LOOP;
  UTL_FILE.FCLOSE(F_OUT);
 END;

 PROCEDURE INDEX_PERCENTAGE_TOO_HIGH IS 
 BEGIN
  CTL_FILE;
		UTL_FILE.PUT_LINE(F_OUT,'TYPE,PERSON PID,SURNAME,FIRST NAMES,ORG,GRADE,DATE LEFT,REASON,INDEX PERCENTAGE,PAYING CODE,AMT,SPOUSE PID,SPOUSE SURNAME,SPOUSE FIRST NAMES');

  FOR REC IN (
   SELECT 'SELF'||','||"PERSON PID"||','||"SURNAME"||','||"FIRST NAMES"||','||"ORG"||','||"GRADE"||','||"DATE LEFT"||','||"REASON"||','||"INDEX PERCENTAGE"||','||"PAYING CODE"||','||"AMT" TEXT FROM (
    SELECT PER_ID "PERSON PID",PER_SURNAME "SURNAME",PER_FNAME "FIRST NAMES",PER_ORG_CODE "ORG", PER_GRD_CODE "GRADE",TO_CHAR(PER_LEFT,'DD-MON-YYYY') "DATE LEFT",PER_LSC_CODE "REASON",
    ROUND(PER_INCPERC,2) "INDEX PERCENTAGE", N.SPD_PDC_CODE "PAYING CODE", SPD_AMT "AMT" 
    FROM PER_PERSON S, PAY_SPAY_DED N WHERE 
    PER_ID=SPD_PER_ID
    and SPD_PDC_CODE in (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='O')
    and S.per_dod is null
    and nvl(S.per_suspended,'N') != 'Y'
    and S.PER_PAYSTOP is null
    and s.PER_INCPERC > 50
    and N.spd_tdate IS NULL
    and N.spd_audit='Y'
    and N.spd_updt='Y') 
    ORDER BY TEXT)
  LOOP
   UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);		
  END LOOP;

  FOR REC IN (
    SELECT 'SPOUSE'||','||"PERSON PID"||','||"SURNAME"||','||"FIRST NAMES"||','||"ORG"||','||"GRADE"||','||"DATE LEFT"||','||"REASON"||','||"INDEX PERCENTAGE"||','||"PAYING CODE"||','||"AMT"||','||
    "SPOUSE PID"||','||"SPOUSE SURNAME"||','||"SPOUSE FIRST NAMES" TEXT FROM (
    SELECT Q."PERSON PID", D.PER_SURNAME SURNAME, D.PER_FNAME "FIRST NAMES", D.PER_ORG_CODE "ORG", D.PER_GRD_CODE "GRADE",TO_CHAR(D.PER_LEFT,'DD-MON-YYYY') "DATE LEFT",  D.PER_LSC_CODE "REASON", 
    ROUND(D.PER_INCPERC,2) "INDEX PERCENTAGE",Q."PAYING CODE",Q."AMT", Q."SPOUSE PID", "SPOUSE SURNAME","SPOUSE FIRST NAMES" FROM (
    SELECT W.DEP_PERID "SPOUSE PID",S.PER_SURNAME "SPOUSE SURNAME", PER_FNAME "SPOUSE FIRST NAMES",SPD_AMT "AMT", N.SPD_PDC_CODE "PAYING CODE",
    W.DEP_PER_ID "PERSON PID" FROM PER_DEPENDENT W, PER_PERSON S, PAY_SPAY_DED N WHERE 
    S.PER_ID=W.DEP_PERID
    AND W.DEP_PERID=SPD_PER_ID
    and N.SPD_PDC_CODE in (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='S')
    and S.per_dod is null
    and nvl(S.per_suspended,'N') != 'Y'
    and S.PER_PAYSTOP is null
    and N.spd_tdate is null
    and N.spd_audit='Y'
    and N.spd_updt='Y'
    AND DEP_RELATION='W') Q, PER_PERSON D
    WHERE Q."PERSON PID"= D.PER_ID
    and D.PER_INCPERC > 50) 
    ORDER BY TEXT)
  LOOP
   UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);		
  END LOOP;
  UTL_FILE.FCLOSE(F_OUT); 
 END;

 PROCEDURE INDEX_PERCENTAGE_TOO_LOW IS 
 BEGIN
  CTL_FILE;
		UTL_FILE.PUT_LINE(F_OUT,'TYPE,PERSON PID,SURNAME,FIRST NAMES,ORG,GRADE,DATE LEFT,REASON,INDEX PERCENTAGE,PAYING CODE,AMT,SPOUSE PID,SPOUSE SURNAME,SPOUSE FIRST NAMES');

  FOR REC IN (
   SELECT 'SELF'||','||"PERSON PID"||','||"SURNAME"||','||"FIRST NAMES"||','||"ORG"||','||"GRADE"||','||"DATE LEFT"||','||"REASON"||','||"INDEX PERCENTAGE"||','||"PAYING CODE"||','||"AMT" TEXT FROM (
    SELECT PER_ID "PERSON PID",PER_SURNAME "SURNAME",PER_FNAME "FIRST NAMES",PER_ORG_CODE "ORG", PER_GRD_CODE "GRADE",TO_CHAR(PER_LEFT,'DD-MON-YYYY') "DATE LEFT",PER_LSC_CODE "REASON",
    ROUND(PER_INCPERC,2) "INDEX PERCENTAGE", N.SPD_PDC_CODE "PAYING CODE", SPD_AMT "AMT" 
    FROM PER_PERSON S, PAY_SPAY_DED N WHERE 
    PER_ID=SPD_PER_ID
    and SPD_PDC_CODE in (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='O')
    and S.per_dod is null
    and nvl(S.per_suspended,'N') != 'Y'
    and S.PER_PAYSTOP is null
    and s.PER_INCPERC <= 25
    and N.spd_tdate IS NULL
    and N.spd_audit='Y'
    and N.spd_updt='Y') 
    ORDER BY TEXT)
  LOOP
   UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);		
  END LOOP;

  FOR REC IN (
    SELECT 'SPOUSE'||','||"PERSON PID"||','||"SURNAME"||','||"FIRST NAMES"||','||"ORG"||','||"GRADE"||','||"DATE LEFT"||','||"REASON"||','||"INDEX PERCENTAGE"||','||"PAYING CODE"||','||"AMT"||','||
    "SPOUSE PID"||','||"SPOUSE SURNAME"||','||"SPOUSE FIRST NAMES" TEXT FROM (
    SELECT Q."PERSON PID", D.PER_SURNAME SURNAME, D.PER_FNAME "FIRST NAMES", D.PER_ORG_CODE "ORG", D.PER_GRD_CODE "GRADE",TO_CHAR(D.PER_LEFT,'DD-MON-YYYY') "DATE LEFT",  D.PER_LSC_CODE "REASON", 
    ROUND(D.PER_INCPERC,2) "INDEX PERCENTAGE",Q."PAYING CODE",Q."AMT", Q."SPOUSE PID", "SPOUSE SURNAME","SPOUSE FIRST NAMES" FROM (
    SELECT W.DEP_PERID "SPOUSE PID",S.PER_SURNAME "SPOUSE SURNAME", PER_FNAME "SPOUSE FIRST NAMES",SPD_AMT "AMT", N.SPD_PDC_CODE "PAYING CODE",
    W.DEP_PER_ID "PERSON PID" FROM PER_DEPENDENT W, PER_PERSON S, PAY_SPAY_DED N WHERE 
    S.PER_ID=W.DEP_PERID
    AND W.DEP_PERID=SPD_PER_ID
    and N.SPD_PDC_CODE in (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='S')
    and S.per_dod is null
    and nvl(S.per_suspended,'N') != 'Y'
    and S.PER_PAYSTOP is null
    and N.spd_tdate is null
    and N.spd_audit='Y'
    and N.spd_updt='Y'
    AND DEP_RELATION='W') Q, PER_PERSON D
    WHERE Q."PERSON PID"= D.PER_ID
    and D.PER_INCPERC <= 25) 
    ORDER BY TEXT)
  LOOP
   UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);		
  END LOOP;
  UTL_FILE.FCLOSE(F_OUT); 
 END;

 PROCEDURE ANY_OTHER_RECORDS_INCR_BESIDE IS 
 BEGIN
		CTL_FILE;
		UTL_FILE.PUT_LINE(F_OUT,'TYPE,SURNAME,FIRST NAMES,NID,PID,ORG,GRADE,REASON,BENID,CODE,CLAIM TYPE,FROM DATE,NEW AMOUNT,OLD AMOUNT,PF NUMBER,DECEASED ID,DECEASED SURNAME,DECEASED FIRST NAMES');
		--SURNAME	FIRST NAMES	NID	PID	ORG	GRADE	REASON	BENID	CODE	FROM DATE	AMT	PF NUMBER
		FOR REC IN (
				SELECT 'SELF'||','||"SURNAME"||','||"FIRST NAMES"||',="'||"NID"||'",'||"PID"||','||"ORG"||','||"GRADE"||','||"REASON"||','||"BENID"||','||"CODE"||','||"CLAIM TYPE"||','||"FROM DATE"||','||"NEW AMOUNT"||','||"OLD AMOUNT"||','||"PF NUMBER" TEXT FROM (
				SELECT DISTINCT R.*,listagg(pf_type||'-'||pf_body,',') within group (order by pf_type||pf_body) as "PF NUMBER"  FROM (
    SELECT S.PER_ID "PID", S.PER_NID "NID",TRIM(S.PER_SURNAME) "SURNAME",S.PER_FNAME "FIRST NAMES",S.PER_ORG_CODE "ORG",S.PER_GRD_CODE "GRADE",
    S.PER_LSC_CODE "REASON",N.SPD_BENID "BENID",N.SPD_PDC_CODE "CODE",N.SPD_CLT_CODE "CLAIM TYPE",TO_CHAR(N.SPD_FDATE,'DD-MON-YYYY') "FROM DATE",SPD_AMT "NEW AMOUNT",  
				(SELECT MAX(O.SPD_AMT) FROM PAY_SPAY_DED O WHERE O.SPD_PER_ID=S.PER_ID AND O.SPD_PDC_CODE=N.SPD_PDC_CODE AND O.SPD_TDATE IS NOT NULL
				AND O.SPD_CLM_SERIAL=N.SPD_CLM_SERIAL-1) "OLD AMOUNT"
    FROM PER_PERSON S, PAY_SPAY_DED N 
    WHERE S.PER_ID=SPD_PER_ID
				and N.SPD_PDC_CODE in (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE != PENS_TYPE AND PEN_CATEGORY='O') 
				and S.per_dod is null
				and nvl(S.per_suspended,'N')!='Y'
				and S.PER_PAYSTOP is null
				and N.spd_tdate IS NULL
				and N.spd_audit='Y'
				and N.spd_updt='Y') R, FTS_MASTER
    WHERE PID=FTS_MASTER.PER_ID(+)
    GROUP BY PID,NID,SURNAME,"FIRST NAMES",ORG,GRADE,REASON,BENID,CODE,"CLAIM TYPE","FROM DATE","NEW AMOUNT","OLD AMOUNT"
    ) ORDER BY  TEXT)
										
		LOOP
			UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);				
		END LOOP;

		FOR REC IN (
				SELECT 'DEPENDENT'||','||"SPOUSE SURNAME"||','||"SPOUSE FIRST NAMES"||',="'||"SPOUSE NID"||'",'||"SPOUSE PID"||','||ORG||','||GRADE||','||REASON||','||BENID||','||CODE||','||"CLAIM TYPE"||','||"FROM DATE"||','||"NEW AMOUNT"||','||
    "OLD AMOUNT"||','||"PF NUMBER"||','||"DECEASED ID"||','||"DECEASED SURNAME"||','|| "DECEASED FIRST NAMES" TEXT FROM (
    SELECT DISTINCT Q.*, D.PER_SURNAME "DECEASED SURNAME",D.PER_FNAME "DECEASED FIRST NAMES",D.PER_ORG_CODE "ORG",D.PER_GRD_CODE "GRADE",D.PER_LSC_CODE "REASON",
    listagg(pf_type||'-'||pf_body,',') within group (order by pf_type||pf_body) as "PF NUMBER"  FROM (
				SELECT W.DEP_PERID "SPOUSE PID",S.PER_NID "SPOUSE NID",TRIM(S.PER_SURNAME) "SPOUSE SURNAME",S.PER_FNAME "SPOUSE FIRST NAMES",
    SPD_AMT "NEW AMOUNT",TO_CHAR(N.SPD_FDATE,'DD-MON-YYYY') "FROM DATE",
				(SELECT MAX(O.SPD_AMT) FROM PAY_SPAY_DED O WHERE O.SPD_PER_ID=W.DEP_PERID AND O.SPD_PDC_CODE=N.SPD_PDC_CODE AND O.SPD_TDATE IS NOT NULL
				AND O.SPD_CLM_SERIAL=N.SPD_CLM_SERIAL-1) "OLD AMOUNT", N.SPD_PDC_CODE "CODE", N.SPD_CLT_CODE "CLAIM TYPE", N.SPD_BENID "BENID", W.DEP_PER_ID "DECEASED ID"
    FROM PER_DEPENDENT W, PER_PERSON S, PAY_SPAY_DED N WHERE 
				S.PER_ID=W.DEP_PERID
				AND W.DEP_PERID=SPD_PER_ID
				and N.SPD_PDC_CODE in (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE != PENS_TYPE AND PEN_CATEGORY IN ('S','C')) 
				and S.per_dod is null
				and nvl(S.per_suspended,'N')!='Y'
				and S.PER_PAYSTOP is null
				and N.spd_tdate IS NULL
				and N.spd_audit='Y'
				and N.spd_updt='Y') Q, PER_PERSON D,FTS_MASTER
				WHERE Q."DECEASED ID"=D.PER_ID
    AND "SPOUSE PID"=FTS_MASTER.PER_ID(+)
    GROUP BY "SPOUSE PID","SPOUSE NID","SPOUSE SURNAME","SPOUSE FIRST NAMES",BENID,CODE,"CLAIM TYPE","FROM DATE","NEW AMOUNT","OLD AMOUNT",
    "DECEASED ID",D.PER_SURNAME,D.PER_FNAME,D.PER_ORG_CODE,D.PER_GRD_CODE,D.PER_LSC_CODE)
				ORDER BY  TEXT)
										
		LOOP
			UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);				
		END LOOP;
		UTL_FILE.FCLOSE(F_OUT);
 END;

 PROCEDURE INSUFFICIENT_EMPLOYMENT_DET IS 
 BEGIN
  CTL_FILE;
		UTL_FILE.PUT_LINE(F_OUT,'TYPE,PERSON PID,PERSON NID,SURNAME,FIRST NAMES,DOB/DOD,ORG,GRADE,DATE LEFT,REASON,INDEX PERCENTAGE,PAYING CODE,AMT,SPOUSE PID,SPOUSE NID,SPOUSE SURNAME,SPOUSE FIRST NAMES,SPOUSE DOB');

  FOR REC IN (
   SELECT 'SELF'||','||"PERSON PID"||',="'||"NID"||'",'||"SURNAME"||','||"FIRST NAMES"||','||"DOB"||','||"ORG"||','||"GRADE"||','||"DATE LEFT"||','||"REASON"||','||"INDEX PERCENTAGE"||','||"PAYING CODE"||','||"AMT" TEXT FROM (
   SELECT PER_SURNAME "SURNAME", PER_FNAME "FIRST NAMES", PER_NID "NID", spd_per_id "PERSON PID", TO_CHAR(PER_DOB,'DD-MON-YY') "DOB", TO_CHAR(PER_LEFT,'DD-MON-YYYY') "DATE LEFT",
   PER_ORG_CODE "ORG", PER_GRD_CODE "GRADE", PER_LSC_CODE "REASON",ROUND(PER_INCPERC,2) "INDEX PERCENTAGE", SPD_PDC_CODE "PAYING CODE", SPD_AMT "AMT" FROM (
    SELECT SPD_PDC_CODE,spd_per_id,SPD_CLC_CODE,spd_benid, SPD_CLM_NO,SPD_AMT 
		  FROM pay_spay_ded, REF_PDCODE 
    where spd_tdate IS NULL
    AND	sPD_PDC_CODE = PDC_CODE
    AND sPD_PDC_PDT_CODE = PDC_PDT_CODE
    AND PDC_PDFLAG='P'
		  AND SPD_PDC_CODE IN (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='O')
    ), PER_PERSON
    WHERE spd_per_id=PER_ID
    AND (PER_ORG_CODE IS NULL OR PER_GRD_CODE IS NULL OR NVL(PER_INCPERC,0) = 0 OR PER_LSC_CODE IS NULL)
    and per_dod is null
    and nvl(per_suspended,'N') != 'Y'
    and PER_PAYSTOP is null) 
    ORDER BY TEXT)
  LOOP
   UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);		
  END LOOP;

  FOR REC IN (
    SELECT 'SPOUSE'||','||"PERSON PID"||',="'||"NID"||'",'||"SURNAME"||','||"FIRST NAMES"||','||"DOD"||','||"ORG"||','||"GRADE"||','||"DATE LEFT"||','||"REASON"||','||"INDEX PERCENTAGE"||','||"PAYING CODE"||','||"AMT"||','||
    "SPOUSE PID"||',="'||"SPOUSE NID"||'",'||"SPOUSE SURNAME"||','||"SPOUSE FIRST NAMES"||','||"SPOUSE DOB" TEXT FROM (
    SELECT D.PER_SURNAME "SURNAME", D.PER_FNAME "FIRST NAMES", DEP_PER_ID "PERSON PID", D.PER_NID "NID", TO_CHAR(D.PER_DOD,'DD-MON-YY') "DOD", TO_CHAR(D.PER_LEFT,'DD-MON-YYYY') "DATE LEFT",
    S.PER_SURNAME "SPOUSE SURNAME", S.PER_FNAME "SPOUSE FIRST NAMES", spd_per_id "SPOUSE PID", SPD_NID "SPOUSE NID", TO_CHAR(S.PER_DOB,'DD-MON-YY') "SPOUSE DOB",
    D.PER_GRD_CODE "GRADE", D.PER_ORG_CODE "ORG", ROUND(D.PER_INCPERC,2) "INDEX PERCENTAGE",D.PER_LSC_CODE "REASON", SPD_PDC_CODE "PAYING CODE", SPD_AMT "AMT" FROM (
    SELECT SPD_PDC_CODE,spd_per_id,SPD_CLC_CODE,SPD_NID, SPD_CLM_NO, SPD_AMT , DEP_PER_ID
		  FROM pay_spay_ded, REF_PDCODE , PER_DEPENDENT
    where spd_tdate IS NULL
    AND	sPD_PDC_CODE = PDC_CODE
    AND sPD_PDC_PDT_CODE = PDC_PDT_CODE
    AND PDC_PDFLAG='P'
    AND spd_per_id = DEP_PERID
    AND DEP_RELATION in ('W')
		  AND SPD_PDC_CODE IN (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='S')
    ), PER_PERSON S, PER_PERSON D
    WHERE spd_per_id=S.PER_ID
    AND DEP_PER_ID=D.PER_ID
    AND (D.PER_ORG_CODE IS NULL OR D.PER_GRD_CODE IS NULL OR NVL(D.PER_INCPERC,0) = 0 OR D.PER_LSC_CODE IS NULL)
    and S.per_dod is null
    and nvl(S.per_suspended,'N') !='Y'
    and S.PER_PAYSTOP is null) 
    ORDER BY TEXT)
  LOOP
   UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);		
  END LOOP;

  FOR REC IN (
    SELECT 'CHILD'||','||"PERSON PID"||',="'||"NID"||'",'||"SURNAME"||','||"FIRST NAMES"||','||"DOD"||','||"ORG"||','||"GRADE"||','||"DATE LEFT"||','||"REASON"||','||"INDEX PERCENTAGE"||','||"PAYING CODE"||','||"AMT"||','||
    "SPOUSE PID"||',="'||"SPOUSE NID"||'",'||"SPOUSE SURNAME"||','||"SPOUSE FIRST NAMES"||','||"SPOUSE DOB" TEXT FROM (
    SELECT D.PER_SURNAME "SURNAME", D.PER_FNAME "FIRST NAMES", DEP_PER_ID "PERSON PID", D.PER_NID "NID", TO_CHAR(D.PER_DOD,'DD-MON-YY') "DOD", TO_CHAR(D.PER_LEFT,'DD-MON-YYYY') "DATE LEFT",
    S.PER_SURNAME "SPOUSE SURNAME", S.PER_FNAME "SPOUSE FIRST NAMES", spd_per_id "SPOUSE PID", SPD_NID "SPOUSE NID", TO_CHAR(S.PER_DOB,'DD-MON-YY') "SPOUSE DOB",
    D.PER_GRD_CODE "GRADE", D.PER_ORG_CODE "ORG", ROUND(D.PER_INCPERC,2) "INDEX PERCENTAGE",D.PER_LSC_CODE "REASON", SPD_PDC_CODE "PAYING CODE", SPD_AMT "AMT" FROM (
    SELECT SPD_PDC_CODE,spd_per_id,SPD_CLC_CODE,SPD_NID, SPD_CLM_NO, SPD_AMT , DEP_PER_ID
		  FROM pay_spay_ded, REF_PDCODE , PER_DEPENDENT
    where spd_tdate IS NULL
    AND	sPD_PDC_CODE = PDC_CODE
    AND sPD_PDC_PDT_CODE = PDC_PDT_CODE
    AND PDC_PDFLAG='P'
    AND spd_per_id = DEP_PERID
    AND DEP_RELATION in ('C','G','W','S')
		  AND SPD_PDC_CODE IN (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='C')
    ), PER_PERSON S, PER_PERSON D
    WHERE spd_per_id=S.PER_ID
    AND DEP_PER_ID=D.PER_ID
    AND (D.PER_ORG_CODE IS NULL OR D.PER_GRD_CODE IS NULL OR NVL(D.PER_INCPERC,0) = 0 OR D.PER_LSC_CODE IS NULL)
    and S.per_dod is null
    and nvl(S.per_suspended,'N') !='Y'
    and S.PER_PAYSTOP is null) 
    ORDER BY TEXT)
  LOOP
   UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);		
  END LOOP;

  FOR REC IN (
   SELECT 'ONE CENT'||','||"PERSON PID"||',="'||"NID"||'",'||"SURNAME"||','||"FIRST NAMES"||','||"DOB"||','||"ORG"||','||"GRADE"||','||"DATE LEFT"||','||"REASON"||','||"INDEX PERCENTAGE"||','||"PAYING CODE"||','||"AMT" TEXT FROM (
   SELECT PER_SURNAME "SURNAME", PER_FNAME "FIRST NAMES", PER_NID "NID", spd_per_id "PERSON PID", TO_CHAR(PER_DOB,'DD-MON-YY') "DOB", TO_CHAR(PER_LEFT,'DD-MON-YYYY') "DATE LEFT",
   PER_ORG_CODE "ORG", PER_GRD_CODE "GRADE", PER_LSC_CODE "REASON",ROUND(PER_INCPERC,2) "INDEX PERCENTAGE", SPD_PDC_CODE "PAYING CODE", SPD_AMT "AMT"
   FROM PAY_SPAY_DED, PER_PERSON
   WHERE  spd_per_id = PER_ID
   AND spd_tdate IS NULL
   AND SPD_AMT <= 0.01) 
    ORDER BY TEXT)
  LOOP
   UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);		
  END LOOP;
  UTL_FILE.FCLOSE(F_OUT);   
 END;

 PROCEDURE DUAL_RETIREMENTS IS 
 BEGIN  
		CTL_FILE;
		UTL_FILE.PUT_LINE(F_OUT,'SURNAME,FIRST NAMES,NID,PID,PF NUMBER');

  FOR REC IN (
   SELECT SURNAME||','||"FIRST NAMES"||',="'||NID||'",'||PID||','||"PF NUMBER" TEXT FROM (
    SELECT "SURNAME","FIRST NAMES","NID",SPD_PER_ID "PID", listagg(pf_type||'-'||pf_body,',') within group (order by pf_type||pf_body) as "PF NUMBER" FROM (
    select distinct per_surname "SURNAME", per_fname "FIRST NAMES", per_nid "NID", SPD_PER_ID, COUNT(distinct SPD_PDC_CODE) from per_person, pay_spay_ded
    where per_id=SPD_PER_ID
    and per_dod is null
    and nvl(per_suspended,'N') !='Y'
    and PER_PAYSTOP is null
    and spd_tdate IS NULL
    and spd_audit='Y'
    and spd_updt='Y'
    and pay_spay_ded.SPD_PDC_CODE in (SELECT PDC_CODE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE=PENS_TYPE AND PEN_CATEGORY='O')
    group by per_surname, per_fname, per_nid, SPD_PER_ID
    having COUNT(distinct SPD_PDC_CODE) > 1) A , FTS_MASTER
    WHERE A.SPD_PER_ID=FTS_MASTER.PER_ID(+)
    group by surname, "FIRST NAMES", nid, SPD_PER_ID) ORDER BY TEXT)
  LOOP
   UTL_FILE.PUT_LINE(F_OUT,REC.TEXT);		
  END LOOP;
  UTL_FILE.FCLOSE(F_OUT);
 END;
BEGIN		

	FOR REC_T IN (SELECT DISTINCT PEN_TYPE FROM REF_PDC_CODE_TYPES WHERE PEN_TYPE = DECODE (PENSION_TYPE,'0',PEN_TYPE,PENSION_TYPE) ORDER BY PEN_TYPE)
	LOOP
		PENS_TYPE:=REC_T.PEN_TYPE;
		FOR REC_REP IN (
			SELECT REPORT_ID, SEC_DESC, REPLACE(REPORT_NAME,' ','_') REP_NAME
			FROM REF_DB_REPORTS, REF_SECTION 
			WHERE ((REPORT_ID=REP_ID AND REP_ID > 99 ) OR (REP_ID=0 AND REPORT_ID > 99)) 
		 AND REPORT_SEC_CODE=SEC_CODE AND NVL(REPORT_PARAMS_LIST,PENS_TYPE)=PENS_TYPE ORDER BY 1) 
		LOOP
		
			 V_REPORT:=PENS_TYPE||'_'||REC_REP.REP_NAME;
			 V_SECTION:=REC_REP.SEC_DESC;
			 REPID:=REC_REP.REPORT_ID;
				--OPEN CTL
				C_OUT:=UTL_FILE.FOPEN(V_DEST,V_REPORT||'.CTL1','W');	
				UTL_FILE.PUT_LINE(C_OUT,V_SECTION||'\REPORTS\');	
			
				IF REPID=100 THEN
				 POLYGAMOUS_SPOUSES;
				END IF;
			 IF REPID=101 THEN
				POLYGAMOUS_SHARING_MINIMUM;
			 END IF;
			 IF REPID=102 THEN
				SPOUSE_RECEIVING_MORE_ONE_PENS; 
			 END IF;
			 IF REPID=103 THEN
				SPOUSE_RECEIVE_MORE_SPOUSE_PEN;
			 END IF;
			 IF REPID=104 THEN
				SPOUSE_NT_SHARNG_RECE_LESS_MIN;
			 END IF;
			 IF REPID=105 THEN
				SPOUSES_ON_MINIMUN;
			 END IF;
			 IF REPID=106 THEN
				DUPLICAT_ARRS_ON_ADHOC_N_STATI;
			 END IF;
			 IF REPID=107 THEN
				INDEX_PERCENTAGE_TOO_HIGH;
			 END IF;
			 IF REPID=108 THEN
				INDEX_PERCENTAGE_TOO_LOW;
			 END IF;
			 IF REPID=109 THEN
				ANY_OTHER_RECORDS_INCR_BESIDE;
			 END IF;
			 IF REPID=110 THEN
				INSUFFICIENT_EMPLOYMENT_DET; 
				END IF;
			 IF REPID=111 THEN
				DUAL_RETIREMENTS; 
				END IF;
			
				UTL_FILE.FCLOSE(C_OUT);
				UTL_FILE.FRENAME('REPORTS',V_REPORT||'.CTL1','REPORTS',V_REPORT||'.CTL');
		
			END LOOP;	
		END LOOP;
		
EXCEPTION WHEN OTHERS THEN 
	UTL_FILE.FCLOSE(F_OUT);
	UTL_FILE.FCLOSE(C_OUT);
	PENSION.DEBUG('POST_INCREASE_REP-'||REP_ID||'-'||SQLERRM);
END POST_INCREASE_REP;

/
